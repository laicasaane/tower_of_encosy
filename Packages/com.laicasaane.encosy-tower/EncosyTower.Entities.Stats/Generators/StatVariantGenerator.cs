#if UNITY_EDITOR && ANNULUS_CODEGEN && ENCOSY_STAT_VALUE_TYPES_GENERATOR

using System;
using EncosyTower.CodeGen;
using UnityCodeGen;

namespace EncosyTower.Entities.Stats.Generators
{
    [Generator]
    internal sealed class StatVariantGenerator : ICodeGenerator
    {
        public void Execute(GeneratorContext context)
        {
            var p = Printer.DefaultLarge;
            p.PrintAutoGeneratedBlock(nameof(StatVariantGenerator));
            p.PrintEndLine();
            p.PrintLine(@"#pragma warning disable

using System;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using EncosyTower.Common;
using Unity.Mathematics;
");

            p.PrintLine("namespace EncosyTower.Entities.Stats");
            p.OpenScope();
            {
                var types = GeneratorAPI.Types.AsSpan();
                var typeNames = GeneratorAPI.TypeNames.AsSpan();
                var equalOperators = GeneratorAPI.EqualOperators.AsSpan();
                var sizes = GeneratorAPI.Sizes.AsSpan();

                p.PrintLine(GeneratorAPI.STRUCT_LAYOUT_EXPLICIT);
                p.PrintLine("partial struct StatVariant : IEquatable<StatVariant>");
                p.OpenScope();
                {
                    p.PrintBeginLine(GeneratorAPI.FIELD_OFFSET_0)
                        .PrintEndLine(" public StatVariantType Type;");

                    for (var i = 0; i < typeNames.Length; i++)
                    {
                        var type = types[i];
                        var typeName = typeNames[i];

                        p.PrintBeginLine(GeneratorAPI.FIELD_OFFSET_1)
                            .Print(" public ").Print(type)
                            .Print(" ").Print(typeName).PrintEndLine(";");
                    }

                    p.PrintEndLine();

                    p.PrintLine(GeneratorAPI.AGGRESSIVE_INLINING);
                    p.PrintLine("public StatVariant(StatVariantType type) : this()");
                    p.OpenScope();
                    {
                        p.PrintLine("Type = type;");
                    }
                    p.CloseScope();
                    p.PrintEndLine();

                    for (var i = 0; i < typeNames.Length; i++)
                    {
                        var type = types[i];
                        var typeName = typeNames[i];
                        var size = sizes[i];

                        p.PrintLine(GeneratorAPI.AGGRESSIVE_INLINING);
                        p.PrintBeginLine("public StatVariant(")
                            .PrintSelect("in ", "", size > 8).Print(type).PrintEndLine(" value) : this()");
                        p.OpenScope();
                        {
                            p.PrintBeginLine("Type = StatVariantType.").Print(typeName).PrintEndLine(";");
                            p.PrintBeginLine(typeName).PrintEndLine(" = value;");
                        }
                        p.CloseScope();
                        p.PrintEndLine();
                    }

                    p.PrintLine(GeneratorAPI.AGGRESSIVE_INLINING);
                    p.PrintLine("public static bool operator ==(in StatVariant a, in StatVariant b)");
                    p.OpenScope();
                    {
                        p.PrintLine("return a.Equals(b);");
                    }
                    p.CloseScope();
                    p.PrintEndLine();

                    p.PrintLine(GeneratorAPI.AGGRESSIVE_INLINING);
                    p.PrintLine("public static bool operator !=(in StatVariant a, in StatVariant b)");
                    p.OpenScope();
                    {
                        p.PrintLine("return a.Equals(b) == false;");
                    }
                    p.CloseScope();
                    p.PrintEndLine();

                    p.PrintLine("public readonly bool Equals(StatVariant other)");
                    p.OpenScope();
                    {
                        p.PrintLine("if (Type != other.Type) return false;");
                        p.PrintEndLine();

                        p.PrintLine("return Type switch");
                        p.OpenScope();
                        {
                            for (var i = 0; i < typeNames.Length; i++)
                            {
                                var typeName = typeNames[i];
                                var op = equalOperators[i];

                                p.PrintBeginLine("StatVariantType.").Print(typeName).Print(" => ").Print(typeName);

                                if (op)
                                {
                                    p.Print(" == other.").Print(typeName).PrintEndLine(",");
                                }
                                else
                                {
                                    p.Print(".Equals(other.").Print(typeName).PrintEndLine("),");
                                }
                            }

                            p.PrintLine("_ => false,");
                        }
                        p.CloseScope("};");
                    }
                    p.CloseScope();
                    p.PrintEndLine();

                    p.PrintLine(GeneratorAPI.AGGRESSIVE_INLINING);
                    p.PrintLine("public readonly override bool Equals(object obj)");
                    p.OpenScope();
                    {
                        p.PrintLine("return obj is StatVariant other && Equals(other);");
                    }
                    p.CloseScope();
                    p.PrintEndLine();

                    p.PrintLine("public readonly override int GetHashCode()");
                    p.OpenScope();
                    {
                        p.PrintLine("return Type switch");
                        p.OpenScope();
                        {
                            for (var i = 0; i < typeNames.Length; i++)
                            {
                                var typeName = typeNames[i];

                                p.PrintBeginLine("StatVariantType.").Print(typeName)
                                    .Print(" => HashValue.Combine(Type, ")
                                    .Print(typeName).PrintEndLine("),");
                            }

                            p.PrintLine("_ => 0,");
                        }
                        p.CloseScope("};");
                    }
                    p.CloseScope();
                    p.PrintEndLine();

                    p.PrintLine("public readonly bool TrySetValueTo(ref StatVariant destination)");
                    p.OpenScope();
                    {
                        p.PrintLine("if (Type != destination.Type)");
                        p.OpenScope();
                        {
                            p.PrintLine("return false;");
                        }
                        p.CloseScope();
                        p.PrintEndLine();

                        p.PrintLine("Option<StatVariant> valueOpt = Type switch");
                        p.OpenScope();
                        {
                            for (var i = 0; i < typeNames.Length; i++)
                            {
                                var typeName = typeNames[i];

                                p.PrintBeginLine("StatVariantType.").Print(typeName)
                                    .Print(" => Option.Some<StatVariant>(")
                                    .Print(typeName)
                                    .PrintEndLine("),");
                            }

                            p.PrintLine("_ => Option.None,");
                        }
                        p.CloseScope("};");
                        p.PrintEndLine();

                        p.PrintLine("destination = valueOpt.GetValueOrDefault();");
                        p.PrintLine("return valueOpt.HasValue;");
                    }
                    p.CloseScope();
                    p.PrintEndLine();

                    p.PrintLine("public readonly void SetValueTo(ref StatVariant destination)");
                    p.OpenScope();
                    {
                        p.PrintLine("ThrowHelper.ThrowIfDestinationTypeMismatch(Type, destination.Type);");
                        p.PrintLine("ThrowHelper.ThrowIfUnsupportedType(destination.Type);");
                        p.PrintEndLine();
                        
                        p.PrintLine("Option<StatVariant> valueOpt = Type switch");
                        p.OpenScope();
                        {
                            for (var i = 0; i < typeNames.Length; i++)
                            {
                                var typeName = typeNames[i];

                                p.PrintBeginLine("StatVariantType.").Print(typeName)
                                    .Print(" => Option.Some<StatVariant>(")
                                    .Print(typeName)
                                    .PrintEndLine("),");
                            }

                            p.PrintLine("_ => Option.None,");
                        }
                        p.CloseScope("};");
                        p.PrintEndLine();

                        p.PrintLine("destination = valueOpt.GetValueOrDefault();");
                    }
                    p.CloseScope();
                    p.PrintEndLine();

                    for (var i = 0; i < typeNames.Length; i++)
                    {
                        var type = types[i];
                        var typeName = typeNames[i];

                        p.PrintLine(GeneratorAPI.AGGRESSIVE_INLINING);
                        p.PrintBeginLine("public readonly bool TrySetValueTo(ref ")
                            .Print(type).PrintEndLine(" destination)");
                        p.OpenScope();
                        {
                            p.PrintBeginLine("if (Type == StatVariantType.").Print(typeName).PrintEndLine(")");
                            p.OpenScope();
                            {
                                p.PrintBeginLine("destination = ").Print(typeName).PrintEndLine(";");
                                p.PrintLine("return true;");
                            }
                            p.CloseScope();
                            p.PrintEndLine();

                            p.PrintLine("return false;");
                        }
                        p.CloseScope();
                        p.PrintEndLine();
                    }

                    for (var i = 0; i < typeNames.Length; i++)
                    {
                        var type = types[i];
                        var typeName = typeNames[i];

                        p.PrintLine(GeneratorAPI.AGGRESSIVE_INLINING);
                        p.PrintBeginLine("public readonly void SetValueTo(ref ")
                            .Print(type).PrintEndLine(" destination)");
                        p.OpenScope();
                        {
                            p.PrintBeginLine("ThrowHelper.ThrowIfDestinationTypeMismatch(Type, StatVariantType.")
                                .Print(typeName).PrintEndLine(");");
                            p.PrintLine("ThrowHelper.ThrowIfUnsupportedType(Type);");
                            p.PrintEndLine();

                            p.PrintBeginLine("destination = ").Print(typeName).PrintEndLine(";");
                        }
                        p.CloseScope();
                        p.PrintEndLine();
                    }

                    for (var i = 0; i < typeNames.Length; i++)
                    {
                        var type = types[i];
                        var typeName = typeNames[i];
                        var size = sizes[i];

                        p.PrintLine(GeneratorAPI.AGGRESSIVE_INLINING);
                        p.PrintBeginLine("public static implicit operator StatVariant(")
                            .PrintSelect("in ", "", size > 8).Print(type).PrintEndLine(" value)");
                        p = p.IncreasedIndent();
                        {
                            p.PrintLine("=> new(value);");
                        }
                        p = p.DecreasedIndent();
                        p.PrintEndLine();
                    }

                    for (var i = 0; i < typeNames.Length; i++)
                    {
                        var type = types[i];
                        var typeName = typeNames[i];

                        p.PrintLine(GeneratorAPI.AGGRESSIVE_INLINING);
                        p.PrintBeginLine("public static explicit operator ").Print(type)
                            .PrintEndLine("(in StatVariant value)");
                        p.OpenScope();
                        {
                            p.PrintBeginLine("ThrowHelper.ThrowIfExplicitlyConvertToWrongType(value.Type, StatVariantType.")
                                .Print(typeName).PrintEndLine(");");
                            p.PrintLine("ThrowHelper.ThrowIfUnsupportedType(value.Type);");
                            p.PrintEndLine();

                            p.PrintBeginLine("return value.").Print(typeName).PrintEndLine(";");
                        }
                        p.CloseScope();
                        p.PrintEndLine();
                    }
                }
                p.CloseScope();
                p.PrintEndLine();
            }
            p.CloseScope();
            p.PrintEndLine();

            context.OverrideFolderPath(CodeGenAPI.GetOutputFolderPathFromCaller(pathCombine: GeneratorAPI.COMMON_FOLDER));
            context.AddCode($"StatVariant.gen.cs", p.Result);
        }
    }
}

#endif
